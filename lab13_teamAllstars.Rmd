---
title: "lab13"
author: "allstars"
date: "11/19/2019"
output: html_document
---

## Individual Sections

### Eugene Miller
```{r, setup}
library(tidyverse)
library(gapminder)

energy_capita <- read_csv('energy_production_per_person.csv')
flood_affected <- read_csv('flood_affected_annual_number.csv')

a <- which(colnames(energy_capita)=="1960")
b <- which(colnames(energy_capita)=="2010")

energy_capita <- energy_capita %>% 
  gather(a:b, key = "Year", value = "Energy Per Capita") %>%
  filter(!is.na(`Energy Per Capita`))

a <- which(colnames(flood_affected)=="1970")
b <- which(colnames(flood_affected)=="2008")

flood_affected <- flood_affected %>% 
  gather(a:b, key = "Year", value = "Flood Affected") %>% 
  filter(!is.na(`Flood Affected`))

data <- full_join(flood_affected,energy_capita, by = c("country", "Year")) %>%
  filter(!is.na(`Energy Per Capita`)) %>% 
  filter(!is.na(`Flood Affected`))

data$Year <- as.numeric(data$Year)

gap_new <- gapminder %>% 
  select(`country`, `year`, `pop`) %>%
  rename("Year" = `year`)

data <- full_join(data, gap_new, by = c("country", "Year")) %>%
  filter(!is.na(pop)) %>% 
  mutate(Flood_cap = `Flood Affected`/`pop`) %>% 
  filter(!is.na(Flood_cap))

```



```{r, message = F, echo = T, message = F, eval = T}

perm_cor <- function(perms = 1000, x, y)
{
  ## Variables ##
  # perms: The number of permutations 
  # x: Vector of Variable 1 - for computing correlation
  # y: Vector of Variable 2 - for computing correlation
  ###############

  #Create zero vector
  vec <- numeric(perms)
  
  # Loop throught number of permutations
  for (i in c(1:perms))
  {
    #Randomize y vector
    r_Y <- sample(y)
    
    #Computer correlation and store
    vec[i] <- cor(x, r_Y)
    
  }
  
  # Return new updated vector
  return(vec)
}


core <- cor( data$`Energy Per Capita`, data$`Flood_cap`)
corellate <- perm_cor(perms = 100000, data$`Energy Per Capita`,  data$`Flood_cap`)


ggplot() + aes(corellate)+ geom_histogram(binwidth=.01, colour="black", fill="white") + geom_vline(mapping =aes(xintercept=core), color = "red") + labs(x = "Correlation Tests")

p_value <- sum(corellate < core)/100000
p_value
```